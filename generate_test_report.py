#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""ä¸´æ—¶è„šæœ¬ï¼šç”Ÿæˆæµ‹è¯•æŠ¥å‘Š"""

import dashscope
from dashscope import Generation
import pandas as pd

dashscope.api_key = 'sk-668c28bae516493d9ea8a3662118ec98'

# ä» CSV åŠ è½½æ•°æ®
df = pd.read_csv('raw_data.csv', encoding='utf-8-sig')
print(f'ä» CSV åŠ è½½ {len(df)} æ¡æ•°æ®')

# æ ¼å¼åŒ–æ•°æ®
formatted = ''
for _, row in df.iterrows():
    platform = str(row.get('å¹³å°', ''))
    icon = 'ğŸ“•' if platform == 'å°çº¢ä¹¦' else ('ğŸµ' if platform == 'æŠ–éŸ³' else 'ğŸŸ¢')
    formatted += f'ã€å¹³å°ï¼š{icon} {platform}ã€‘\n'
    formatted += f'å…³é”®è¯ï¼š{str(row.get("å…³é”®è¯", ""))}\n'
    formatted += f'æ ‡é¢˜ï¼š{str(row.get("æ ‡é¢˜", ""))}\n'
    formatted += f'é“¾æ¥ï¼š{str(row.get("é“¾æ¥", ""))}\n'
    comments = str(row.get('è¯„è®ºå†…å®¹', ''))
    if comments and len(comments.strip()) > 10 and comments != 'nan':
        formatted += f'ğŸ”¥ ç”¨æˆ·è¯„è®ºï¼š{comments[:200]}\n'
    formatted += '-------------------\n'

print(f'æ ¼å¼åŒ–æ•°æ®é•¿åº¦: {len(formatted)} å­—ç¬¦')

system_prompt = """ä½ ä¸æ˜¯é”€å”®ï¼Œä½ æ˜¯æµ·é©¬èŒåŠ çš„**é¦–å¸­æˆ˜ç•¥å®˜ (CSO)**ã€‚
ä½ æ‹¥æœ‰æ•é”çš„å¸‚åœºæ´å¯ŸåŠ›ã€‚è¯·æ ¹æ®é‡‡é›†åˆ°çš„å…¨ç½‘æ•°æ®ï¼ˆæŠ–éŸ³/å°çº¢ä¹¦/å¾®ä¿¡ï¼‰ï¼Œä¸ºç®¡ç†å±‚æ’°å†™ä¸€ä»½ã€Šå…¨ç½‘å¸‚åœºé›·è¾¾æ—¥æŠ¥ã€‹ã€‚

**åˆ†æé€»è¾‘ä¸è¾“å‡ºæ ¼å¼ (Markdown)**ï¼š

**ç¬¬ä¸€éƒ¨åˆ†ï¼šâš”ï¸ ç«å“åŠ¨ä½œç›‘æµ‹ (Competitor Moves)**
- æ ¸å¿ƒå…³æ³¨ï¼šç«å“ï¼ˆDBCã€é€”é¸½ã€Offerå…ˆç”Ÿç­‰ï¼‰æœ€è¿‘å‘äº†ä»€ä¹ˆæ–°äº§å“ï¼Ÿæäº†ä»€ä¹ˆæ´»åŠ¨ï¼Ÿæœ‰ä»€ä¹ˆä»·æ ¼å˜åŠ¨ï¼Ÿ
- æ ¼å¼ï¼š`[å¹³å°] ç«å“åï¼šå…·ä½“åŠ¨ä½œ`ã€‚

**ç¬¬äºŒéƒ¨åˆ†ï¼šğŸ“¢ ç”¨æˆ·èˆ†æƒ…é€è§† (Voice of Customer)**
- æ ¸å¿ƒå…³æ³¨ï¼šç”¨æˆ·åœ¨è¯„è®ºåŒºéª‚ä»€ä¹ˆï¼Ÿç—›ç‚¹åœ¨å“ªé‡Œï¼Ÿ
- **å¿…é¡»æ‘˜å½•**ï¼šä»æ•°æ®ä¸­æå– 3-5 æ¡æœ€å…·ä»£è¡¨æ€§çš„**è´Ÿé¢è¯„è®ºåŸè¯**ï¼Œä½œä¸º"ç”¨æˆ·åŸå£°"å±•ç¤ºã€‚
- æ€»ç»“ï¼šå½“å‰çš„èˆ†æƒ…çƒ­è¯æ˜¯ä»€ä¹ˆï¼ˆå¦‚ï¼šé€€è´¹éš¾ã€å¯¼å¸ˆæ°´ï¼‰ã€‚

**ç¬¬ä¸‰éƒ¨åˆ†ï¼šğŸ§­ æˆ‘ä»¬çš„æˆ˜ç•¥å¯ç¤º (Strategic Insights)**
- **è¿™æ˜¯æœ€é‡è¦çš„éƒ¨åˆ†**ã€‚åŸºäºä¸Šè¿°ç«å“åŠ¨ä½œå’Œç”¨æˆ·èˆ†æƒ…ï¼Œç»™æˆ‘ä»¬ï¼ˆæµ·é©¬èŒåŠ ï¼‰æå‡º 3 æ¡å…·ä½“çš„æˆ˜ç•¥å»ºè®®ã€‚
- *ä¸è¦å†™è¯æœ¯*ï¼Œè¦å†™ç­–ç•¥ã€‚
- ä¾‹å¦‚ï¼š'ç«å“Aå› ä¸ºé€€è´¹éš¾è¢«éª‚ -> å¯ç¤ºï¼šæˆ‘ä»¬åº”åœ¨å®£å‘ä¸­å¼ºè°ƒèµ„é‡‘ç›‘ç®¡å’Œé€æ˜é€€è´¹æµç¨‹ï¼Œå»ºç«‹ä¿¡ä»»å£å’ã€‚'

**é£æ ¼è¦æ±‚**ï¼š
- è¯­è¨€ç®€ç»ƒã€ä¸“ä¸šã€æ¯’è¾£ã€‚
- æ‹’ç»åºŸè¯ï¼Œç›´å‡»æœ¬è´¨ã€‚
- **å»ºè®®å¿…é¡»åŸºäºä»Šæ—¥æŠ“å–çš„å…·ä½“æ•°æ®ï¼Œä¸¥ç¦ç”Ÿæˆé€šç”¨å»ºè®®ã€‚**"""

user_prompt = f"""ä»¥ä¸‹æ˜¯ä»Šæ—¥é‡‡é›†åˆ°çš„æœ€æ–°ç«å“æƒ…æŠ¥æ•°æ®ï¼ˆæœ€è¿‘3å¤©ï¼‰ï¼š

{formatted[:5000]}

è¯·æ ¹æ®ä»¥ä¸Šæ•°æ®ç”Ÿæˆã€Šå…¨ç½‘å¸‚åœºé›·è¾¾æ—¥æŠ¥ã€‹ï¼Œæ ¼å¼ä¸º Markdownã€‚
æ¯æ¡æƒ…æŠ¥å¿…é¡»åŒ…å«åŸå§‹é“¾æ¥ï¼Œä¸¥ç¦ç¼–é€ ä¿¡æ¯ã€‚
**ç‰¹åˆ«æ³¨æ„**ï¼š
1. å¦‚æœæ•°æ®ä¸­åŒ…å«ç”¨æˆ·è¯„è®ºï¼Œå¿…é¡»æ‘˜å½•åŸè¯å±•ç¤ºã€‚
2. æˆ˜ç•¥å»ºè®®å¿…é¡»åŸºäºä¸Šè¿°å…·ä½“æ•°æ®ï¼Œä¸èƒ½å†™é€šç”¨å»ºè®®ã€‚
3. å¦‚æœæ•°æ®ä¸­æ²¡æœ‰è¯„è®ºï¼Œè¯·æ˜ç¡®è¯´æ˜"æœ¬æ¬¡æœªé‡‡é›†åˆ°ç”¨æˆ·è¯„è®ºæ•°æ®"ã€‚
4. ä¼˜å…ˆåˆ†æå°çº¢ä¹¦å¹³å°çš„è´Ÿé¢è¯„ä»·ï¼Œå› ä¸ºé€šå¸¸æœ€çœŸå®ã€‚"""

try:
    print("è°ƒç”¨é˜¿é‡Œåƒé—® API...")
    response = Generation.call(
        model='qwen-plus',
        messages=[
            {'role': 'system', 'content': system_prompt},
            {'role': 'user', 'content': user_prompt}
        ],
        result_format='message'
    )
    
    if response.status_code == 200:
        report = response.output.choices[0].message.content
        print('\n' + '=' * 80)
        print('ã€å…¨ç½‘å¸‚åœºé›·è¾¾æ—¥æŠ¥ - æµ‹è¯•æ•ˆæœé¢„è§ˆã€‘')
        print('=' * 80)
        print(f'# æµ·é©¬èŒåŠ Â·å…¨ç½‘å¸‚åœºé›·è¾¾æ—¥æŠ¥')
        print(f'**ç”Ÿæˆæ—¶é—´**: 2025-12-13')
        print('---')
        print(report)
        print('=' * 80)
    else:
        print(f'API è°ƒç”¨å¤±è´¥: {response.status_code}, {response.message}')
except Exception as e:
    print(f'é”™è¯¯: {str(e)}')
    import traceback
    traceback.print_exc()
